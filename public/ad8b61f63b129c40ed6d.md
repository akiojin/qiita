---
title: Azure Functions + SignalR ã‚’ä½¿ã£ã¦ã¿ã‚‹
tags:
  - SignalR
  - AzureFunctions
private: false
updated_at: '2021-10-25T14:15:35+09:00'
id: ad8b61f63b129c40ed6d
organization_url_name: cloud-creative-studios
---
# ã¯ã˜ã‚ã«

[Unity + Azure SignalR ã§ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡](https://qiita.com/akiojin/items/e648668ac1f2336e245c) ã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç´¹ä»‹ã‚’ã—ã¾ã—ãŸãŒã€ã‚µãƒ¼ãƒãƒ¼å´ã®å®Ÿè£…ã‚‚ç´¹ä»‹ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ä»Šå›ã¯ SignalR ã‚’ Azure Functions ã§ä½¿ç”¨ã—ã¾ã™ã€‚
ã¾ãŸã€[å‰å›ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ¼ãƒ‰](https://qiita.com/akiojin/items/e648668ac1f2336e245c)ã‚’åˆ©ç”¨ã™ã‚‹å‰æã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚

# SignalR ã«æ¥ç¶šã™ã‚‹ãŸã‚ã® negotiate é–¢æ•°

SignalR ã«æ¥ç¶šã™ã‚‹ãŸã‚ã«ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç´¹ä»‹ã§ã‚‚è¨˜è¼‰ã—ã¾ã—ãŸãŒ .NET ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã® Microsoft.AspNetCore.SignalR.Client ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

SignalR.Client ã§ã¯ HubConnection ã¨ã„ã†ã‚¯ãƒ©ã‚¹ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®ã‚¯ãƒ©ã‚¹ãŒ SignalR ã«æ¥ç¶šã™ã‚‹éš›ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯æœ€åˆã« negotiate é–¢æ•°ã«ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¡Œã„ã¾ã™ã€‚
negotiate é–¢æ•°ã§ã¯ SignalR ã«æ¥ç¶šã™ã‚‹ãŸã‚ã® URL ã‚„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã®æƒ…å ±ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™å½¹å‰²ã‚’ã‚‚æŒã£ã¦ã„ã‚‹ã®ã§ã€ã“ã®é–¢æ•°ã‚’é…ç½®ã—ã¾ã™ã€‚ï¼ˆã¡ãªã¿ã« negotiate é–¢æ•°ã‚’ä½¿ã‚ãšã«è¡Œã†ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼‰

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

ä»Šå›ã¯ä»¥ä¸‹ã®æ¡ä»¶ã§ Azure Functions ã‚’å®Ÿè£…ã—ã¦ã„ã¾ã™ã€‚

- é–¢æ•°å˜ä½ã®èªè¨¼ã‚’è¡Œã†
- SignalR ã¸ã®æ¥ç¶šã¯ä»»æ„ã® ID ã‚’åŸºã«è¡Œã†

ã§ã¯ã€æ—©é€Ÿã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã™ã€‚

```C#
using System;
using System.Threading.Tasks;
using System.Web.Http;
using Microsoft.AspNetCore.Http;
using Microsoft.AspNetCore.Mvc;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.Http;
using Microsoft.Azure.WebJobs.Extensions.SignalRService;
using Microsoft.Extensions.Logging;

public static class Negotiate
{
	const string Function_Name = "negotiate";
	const string User_Id = "x-userid";

	[FunctionName(Function_Name)]
	public static async Task<IActionResult> Run(
		[HttpTrigger(AuthorizationLevel.Function, "POST")] HttpRequest req,
		IBinder binder,
		ILogger logger)
	{
		// ä»¥ä¸‹ã«å‡ºç¾ã™ã‚‹ AppSettings ã¯è¨­å®šã‚’ä¿å­˜ã™ã‚‹å˜ãªã‚‹é™çš„ãªã‚¯ãƒ©ã‚¹ã§ã™
		using (logger.BeginScope(Function_Name)) {
			try {
				if (!!string.IsNullOrEmpty(req.Headers[User_Id])) {
					return new UnauthorizedResult();
				}

				logger.LogTrace($"negotiate: HubName={AppSettings.SignalR_HubName}, User ID={req.Headers[User_Id]}");

				var attribute = new SignalRConnectionInfoAttribute {
					HubName = AppSettings.SignalR_HubName,
					UserId = req.Headers[User_Id],
					ConnectionStringSetting = AppSettings.SignalR_Connection_Key
				};
				var connectionInfo = await binder.BindAsync<SignalRConnectionInfo>(attribute);

				logger.LogTrace($"SignalR Connection Info: Url={connectionInfo.Url}, AccessToken={connectionInfo.AccessToken}");

				return new OkObjectResult(connectionInfo);
			} catch (Exception ex) {
				return new ExceptionResult(ex, true);
			}
		}
	}
}
```

### é–¢æ•°å˜ä½ã§ã®èªè¨¼

æ¡ä»¶ã«ã‚‚è¨˜è¼‰ã—ã¾ã—ãŸãŒã€ã€é–¢æ•°å˜ä½ã§ã®èªè¨¼ã€ã‚’è¡Œã†ãŸã‚ãƒã‚¤ãƒ³ãƒ‰ã®è¨­å®šã‚’è¡Œã£ã¦ã„ã¾ã™ã€‚

```C#
[HttpTrigger(AuthorizationLevel.Function, "POST")] HttpRequest req,
```

ã“ã®è¨­å®šã‚’è¡Œã£ãŸå ´åˆã€HTTP ã§å‘¼ã³å‡ºã™éš›ã«ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã€x-function-keyã€ã« Azure ãƒãƒ¼ã‚¿ãƒ«ã§å–å¾—å¯èƒ½ãªãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã¯ã€é–¢æ•°ã‚¢ãƒ—ãƒª > ã‚¢ãƒ—ãƒªã‚­ãƒ¼ > ãƒ›ã‚¹ãƒˆã‚­ãƒ¼ã€ã§å–å¾—å¯èƒ½ã§ã™ã€‚

### SignalR ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–¢é€£ä»˜ã‘

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ã™ã‚‹ãŸã‚ã« SignalR ã«ãã‚Œã‚’æ•™ãˆã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ãƒãƒƒãƒˆä¸Šã«å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ SignalR ã®èª¬æ˜ã§ä»¥ä¸‹ã®ã‚ˆã†ãªã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ã‚ˆãè¦‹ã‹ã‘ã¾ã™ã€‚

```C#
public static SignalRConnectionInfo Negotiate(
	[HttpTrigger(AuthorizationLevel.Function, Route = "negotiate")] HttpRequest req,
	[SignalRConnectionInfo(HubName = "hub")]SignalRConnectionInfo signalRConnectionInfo) =>
	signalRConnectionInfo;
```

ã“ã®æ›¸ãæ–¹ã ã¨ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ã™ã‚‹æ–¹æ³•ãŒãªãã€ã¾ãŸ DI ã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹é–¢ä¿‚ã§ SignalRConnectionInfo ã«å¯¾ã—ã¦ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æ¸¡ã™ãƒ˜ãƒƒãƒ€ãƒ¼æƒ…å ±ã‚’å‚ç…§ã™ã‚‹ã“ã¨å‡ºæ¥ã¾ã›ã‚“ã€‚ï¼ˆå‡ºæ¥ã‚‹æ–¹æ³•ãŒã‚ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã¡ã‚‡ã£ã¨èª¿ã¹ã¦ã‚‚åˆ†ã‹ã‚‰ãªã‹ã£ãŸã§ã™ï¼‰

ä»Šå›ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰æ¸¡ã•ã‚Œã¦ãã‚‹ ID ã‚’åˆ©ç”¨ã—ãŸã„ã¨æ€ã„ã¾ã™ã®ã§ã€ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’åˆ©ç”¨ã—ã¦ SignalRConnectionInfoAttribute ã« ID ã‚’è¨­å®šã—ã¾ã™ã€‚

```C#
var attribute = new SignalRConnectionInfoAttribute {
	HubName = AppSettings.SignalR_HubName,
	UserId = req.Headers[User_Id],
	ConnectionStringSetting = AppSettings.SignalR_Connection_Key
};
var connectionInfo = await binder.BindAsync<SignalRConnectionInfo>(attribute);
return new OkObjectResult(connectionInfo);
```

ã“ã‚Œã§ SignalR ã‹ã‚‰ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚Œã‚‹æº–å‚™ãŒå‡ºæ¥ã¾ã—ãŸã€‚

# ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¯ãƒ©ã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹

ã§ã¯ã€å®Ÿéš›ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã«ã¯ã©ã†ã™ã‚Œã°ã‚ˆã„ã‹ã¨è¨€ã†ã¨ IAsyncCollector ã¨ SignalRMessage ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã‚’åˆ©ç”¨ã—ã¾ã™ã€‚
IAsyncCollector ã«å¯¾ã—ã¦ SignalRMessage ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚

```C#
// ç‰¹å®šã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
public static async Task SendMessage(this IAsyncCollector<SignalRMessage> message, string userId, string target, object arg)
	=> await message.AddAsync(
		new SignalRMessage() {
			UserId = userId,
			Target = target,
			Arguments = new[] { arg }
		});

// SignalR ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã™ã‚‹
public static async Task SendMessage(this IAsyncCollector<SignalRMessage> message, string target, object arg)
	=> await message.AddAsync(
		new SignalRMessage() {
			Target = target,
			Arguments = new[] { arg }
		});
```

ä¸Šè¨˜ã®ãƒ¡ã‚½ãƒƒãƒ‰ã® target ã«ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®å‘¼ã³å‡ºã™ãƒ¡ã‚½ãƒƒãƒ‰åã‚’è¨˜è¼‰ã—ã¾ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã§è¨€ãˆã° "Hello_World" ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

## ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰

ä¸Šè¨˜ã® SignalR ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€ä¿¡ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ãŒã€5åˆ†ãŠãã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€ä¿¡ã™ã‚‹å†…å®¹ã§ã™ã€‚

```C#
using System.Collections.Generic;
using System.Threading.Tasks;
using GrimoireEngine.SignalR;
using Microsoft.Azure.WebJobs;
using Microsoft.Azure.WebJobs.Extensions.SignalRService;
using Microsoft.Extensions.Logging;

public static class Watchdog
{
	const string Function_Name = "Watchdog";

	[FunctionName(Function_Name)]
	public static async Task Run(
		[TimerTrigger("0 5 * * * *")] TimerInfo timer,
		[SignalR(HubName = AppSettings.SignalR_HubName, ConnectionStringSetting = AppSettings.SignalR_Connection_Key)] IAsyncCollector<SignalRMessage> message,
		ILogger logger)
	{
		await message.SendMessage("Hello_World", null);
	}
}
```

ã„ããªã‚Š Azure Functions ã®ã‚¿ã‚¤ãƒãƒ¼ãƒˆãƒªã‚¬ãƒ¼ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ãŒã€ã“ã¡ã‚‰ã¯ã‚µãƒ¼ãƒãƒ¼ä¸»å°ã§å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ã‚µãƒ³ãƒ—ãƒ«ã§ã™ã®ã§ã€ãã†ã„ã†ã‚‚ã®ã ã¨æ€ã£ã¦ãã ã•ã„ğŸ’¦

ä¸Šè¨˜ã®å†…å®¹ã§ Azure Functions ã‚’èµ·å‹•ã™ã‚‹ã¨ç™»éŒ²ã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ã¯5åˆ†ãŠãã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ "Hello_World" ã¨ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨æ€ã„ã¾ã™ã€‚

ã‚µãƒ³ãƒ—ãƒ«ã§ã¯å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¦ã„ã¾ã™ãŒã€ã‚²ãƒ¼ãƒ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãªã©ã§ã¯ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ã¦é€ä¿¡ã™ã‚‹ãªã©ã®å‡¦ç†ãŒå¿…è¦ã«ãªã‚‹ã¨æ€ã„ã¾ã™ãŒã€ä»Šå›ã¯ã‚´ãƒƒã‚½ãƒªå‰²æ„›ã—ã¦ã—ã¾ã£ã¦ã„ã¾ã™ãŒã€SignalRGroupAction ã‚’ä½¿ãˆã°ç°¡å˜ã«å®Ÿè£…ã§ãã¾ã™ã€‚

# ãŠã‚ã‚Šã«

ä»Šå›ã® SignalR ã‚µãƒ¼ãƒãƒ¼ã§ä¸€ç•ªãƒãƒã£ãŸã¨ã“ã‚ã¨ã—ã¦ã¯ ID ã‚’ã‚µãƒ¼ãƒãƒ¼ã«æ¸¡ã™éš›ã«ã‚«ã‚¹ã‚¿ãƒ ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’åˆ©ç”¨ã—ãªã„ã¨ã„ã‘ãªã„éƒ¨åˆ†ã§ã—ãŸã€‚

SignalR ã®èª¬æ˜ã¨è¨€ã£ã¦ã‚‚ãªã‹ãªã‹ã“ã®è¾ºã‚Šã®æƒ…å ±ãŒéå¸¸ã«å°‘ãªãæ‰‹æ¢ã‚ŠçŠ¶æ…‹ã§ã—ãŸã€‚

ã¨ã¯ã„ãˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è­˜åˆ¥ã•ãˆå‡ºæ¥ã¦ã—ã¾ãˆã°ã€ãã‚Œä»¥é™ã®å®Ÿè£…ã¯éå¸¸ã«ç°¡å˜ã§ã™ã®ã§ã€ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ãŒå¿…è¦ãªå ´åˆã¯ä¸€åº¦æ¤œè¨ã—ã¦ã‚‚ã‚‰ã£ã¦ã‚‚ã„ã„ã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã„ã¾ã™ã€‚
